# 自定义音色 TTS 功能产品文档

## 1. 功能概述

### 1.1 背景

当前系统使用 Web Speech API 进行文本朗读，受限于浏览器内置的语音，无法使用自定义音色。为了提供更好的阅读体验，我们计划集成端侧 AI TTS 引擎，支持用户训练和管理自定义音色。

### 1.2 核心功能

- **端侧 TTS 引擎**：在浏览器中运行 TTS 模型，无需依赖服务器
- **音色训练**：用户可以通过录制样本训练自定义音色
- **音色管理**：管理多个自定义音色，支持导入/导出
- **音色切换**：在阅读时可以切换使用不同的音色
- **AI 驱动**：结合端侧 AI 模型，优化朗读效果

## 2. 技术方案

### 2.1 架构设计

```
┌─────────────────────────────────────────┐
│           阅读器界面 (Reader)            │
│  - TTS 控制面板                          │
│  - 音色选择器                            │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│      TTS 服务层 (useCustomTTS)          │
│  - 音色管理                              │
│  - TTS 引擎调用                          │
│  - 音频播放                              │
└──────────────┬──────────────────────────┘
               │
     ┌─────────┴─────────┐
     │                   │
┌────▼─────┐    ┌────────▼────────┐
│ Web Speech│    │  端侧 TTS 引擎   │
│  API      │    │  (Piper/Coqui)  │
│ (传统模式) │    │  自定义音色模式  │
└───────────┘    └─────────────────┘
```

### 2.2 技术栈选择

#### 方案 A：Piper TTS（推荐）

- **优势**：
  - 轻量级，模型体积小（~20MB）
  - 支持语音克隆（需要额外模型）
  - 可以在浏览器中运行（通过 WebAssembly）
  - 中文支持良好
- **劣势**：
  - 需要集成 WebAssembly
  - 音色训练需要额外工具链

#### 方案 B：Coqui TTS

- **优势**：
  - 功能强大，支持多种语言
  - 社区活跃
  - 支持实时语音克隆
- **劣势**：
  - 模型较大
  - 集成复杂度较高

#### 方案 C：Web Speech API + 后端服务（混合方案）

- **优势**：
  - 前端简单
  - 可以调用专业的 TTS 服务
- **劣势**：
  - 需要后端支持
  - 不符合"端侧"要求

**推荐方案：方案 A（Piper TTS）**

### 2.3 数据流

```
用户训练音色流程：
1. 用户上传/录制音频样本（至少 3-5 分钟）
2. 前端预处理音频（降噪、格式转换）
3. 调用音色训练服务（可在后端或本地）
4. 生成音色模型文件（.onnx 或 .json）
5. 保存到 IndexedDB
6. 可选：导出/导入音色文件

朗读流程：
1. 用户选择章节开始朗读
2. 检查是否使用自定义音色
3. 如果是自定义音色：
   - 加载对应的 TTS 模型和音色模型
   - 将文本输入 TTS 引擎
   - 生成音频流
   - 使用 Web Audio API 播放
4. 如果是传统模式：
   - 使用 Web Speech API（保持兼容）
```

## 3. 功能模块

### 3.1 音色管理模块

#### 3.1.1 音色列表

- 显示所有已训练/导入的音色
- 显示音色名称、创建时间、样本时长
- 支持预览（播放测试音频）
- 支持编辑、删除、导出

#### 3.1.2 音色训练

- **上传音频样本**：
  - 支持 WAV/MP3 格式
  - 要求：单声道，16kHz 采样率
  - 建议时长：3-10 分钟
  - 清晰无背景噪音
- **训练设置**：
  - 音色名称
  - 训练轮数（影响质量）
  - 是否进行数据增强
- **训练进度**：
  - 显示训练进度
  - 预计剩余时间
  - 可取消训练
- **训练完成**：
  - 自动保存音色
  - 生成预览音频
  - 提供测试功能

#### 3.1.3 音色导入/导出

- **导出**：
  - 导出为单个文件（包含模型和元数据）
  - 格式：`.voice`（zip 压缩包）
- **导入**：
  - 支持导入 `.voice` 文件
  - 验证文件完整性
  - 自动添加音色

### 3.2 TTS 引擎模块

#### 3.2.1 引擎初始化

- 检测 WebAssembly 支持
- 加载 TTS 基础模型
- 初始化 Web Audio API
- 预加载常用音色

#### 3.2.2 文本处理

- 文本分段（按句子/段落）
- 标点符号处理
- 情感标记处理（可选）
- 文本预处理（清理、格式化）

#### 3.2.3 音频生成

- 调用 TTS 引擎生成音频
- 支持流式生成（实时播放）
- 音频后处理（音量、速度调整）

#### 3.2.4 音频播放

- 使用 Web Audio API 播放
- 支持暂停/继续/停止
- 进度追踪
- 自动播放下一段

### 3.3 用户界面模块

#### 3.3.1 TTS 控制面板增强

- 音色选择器（下拉菜单）
- 切换按钮（自定义/传统模式）
- 音色预览按钮
- 音色管理入口

#### 3.3.2 音色管理页面

- 路径：`/voice-settings`
- 功能：
  - 音色列表展示
  - 新增音色（训练）
  - 导入/导出
  - 编辑/删除

#### 3.3.3 音色训练页面

- 路径：`/voice-settings/train`
- 功能：
  - 音频上传/录制
  - 训练设置
  - 训练进度
  - 训练结果预览

## 4. 数据结构

### 4.1 音色元数据

```typescript
interface VoiceModel {
  id: string; // 唯一标识
  name: string; // 音色名称
  createdAt: number; // 创建时间戳
  updatedAt: number; // 更新时间戳
  sampleDuration: number; // 样本时长（秒）
  modelSize: number; // 模型大小（字节）
  version: string; // 模型版本
  metadata: {
    language: string; // 语言
    gender?: string; // 性别（可选）
    age?: string; // 年龄（可选）
    description?: string; // 描述
    tags?: string[]; // 标签
  };
}
```

### 4.2 存储结构

```
IndexedDB:
  - voices: 音色元数据
  - voice_models: 音色模型文件（二进制）
  - voice_samples: 原始音频样本（可选）

LocalStorage:
  - custom-tts-enabled: 是否启用自定义 TTS
  - default-voice-id: 默认音色 ID
  - tts-engine: 'web-speech' | 'custom'
```

## 5. 用户流程

### 5.1 首次使用

1. 用户进入阅读器
2. 点击 TTS 按钮
3. 系统提示：是否尝试自定义音色功能
4. 引导用户训练第一个音色

### 5.2 训练音色

1. 进入音色管理页面
2. 点击"训练新音色"
3. 上传音频样本（或录制）
4. 设置音色名称和参数
5. 开始训练（显示进度）
6. 训练完成后预览
7. 保存并使用

### 5.3 使用自定义音色朗读

1. 在阅读器中选择章节
2. 打开 TTS 控制面板
3. 选择音色（默认或自定义）
4. 开始朗读
5. 实时播放，支持暂停/继续

## 6. 技术实现细节

### 6.1 前端集成

#### 6.1.1 依赖安装

```bash
# 需要评估具体的 TTS 库
# 可能需要的依赖：
npm install @piper-tts/core  # 如果使用 Piper
# 或者
npm install coqui-tts        # 如果使用 Coqui
```

#### 6.1.2 核心文件结构

```
src/
  composables/
    useCustomTTS.ts          # 自定义 TTS 组合函数
    useVoiceTraining.ts      # 音色训练组合函数
  stores/
    voice.ts                 # 音色管理 Store
  pages/
    voice-settings.vue       # 音色管理页面
    voice-train.vue          # 音色训练页面
  components/
    voice/
      VoiceList.vue          # 音色列表组件
      VoiceCard.vue          # 音色卡片组件
      VoiceTrainer.vue       # 音色训练组件
      VoiceSelector.vue      # 音色选择器组件
  utils/
    voice/
      audioProcessor.ts      # 音频处理工具
      modelLoader.ts         # 模型加载工具
      storage.ts             # 音色存储工具
```

### 6.2 API 设计（如果需要后端支持）

```typescript
// 音色训练 API（如果训练在服务器端）
POST /api/voice/train
  Body: {
    audio: File
    name: string
    settings: TrainingSettings
  }
  Response: {
    voiceId: string
    progressUrl: string  // SSE 进度流
  }

// 获取训练进度
GET /api/voice/train/:voiceId/progress
  Response: SSE stream

// 下载训练结果
GET /api/voice/:voiceId/download
  Response: .voice file
```

### 6.3 性能优化

1. **模型加载**：

   - 懒加载：只在需要时加载音色模型
   - 缓存：已加载的模型保持在内存中
   - 预加载：预加载常用音色

2. **音频生成**：

   - 流式生成：边生成边播放
   - 分段处理：长文本分段处理
   - Web Worker：在 Worker 中运行 TTS 引擎

3. **存储优化**：
   - 压缩：模型文件压缩存储
   - 清理：定期清理未使用的模型
   - 索引：使用 IndexedDB 索引加速查询

## 7. 兼容性考虑

### 7.1 浏览器支持

- WebAssembly：必需（TTS 引擎）
- Web Audio API：必需（音频播放）
- IndexedDB：必需（存储）
- File API：必需（文件上传）
- MediaRecorder API：可选（录制功能）

### 7.2 降级方案

- 如果浏览器不支持 WebAssembly：回退到 Web Speech API
- 如果音色加载失败：使用默认音色或 Web Speech API
- 如果训练失败：提示用户并提供替代方案

### 7.3 渐进增强

- 基础功能：Web Speech API（所有浏览器）
- 增强功能：自定义音色（支持 WebAssembly 的浏览器）
- 高级功能：音色训练（需要额外支持）

## 8. 开发计划

### 8.1 Phase 1: 基础集成（2-3 周）

- [ ] 研究并选择 TTS 引擎
- [ ] 集成 TTS 引擎到前端
- [ ] 实现基础 TTS 功能（使用默认音色）
- [ ] 与现有 TTS 系统集成
- [ ] 测试和优化

### 8.2 Phase 2: 音色管理（2-3 周）

- [ ] 设计音色数据结构
- [ ] 实现音色存储（IndexedDB）
- [ ] 开发音色管理界面
- [ ] 实现音色导入/导出
- [ ] 音色选择器组件

### 8.3 Phase 3: 音色训练（3-4 周）

- [ ] 音频上传/录制功能
- [ ] 音频预处理工具
- [ ] 音色训练流程（前端或后端）
- [ ] 训练进度显示
- [ ] 训练结果预览和保存

### 8.4 Phase 4: 优化和测试（1-2 周）

- [ ] 性能优化
- [ ] 错误处理完善
- [ ] 用户体验优化
- [ ] 兼容性测试
- [ ] 文档完善

## 9. 风险和挑战

### 9.1 技术风险

- **模型大小**：TTS 模型可能较大，影响加载速度
- **浏览器兼容性**：WebAssembly 支持可能不完善
- **音质**：端侧 TTS 音质可能不如云端服务
- **训练复杂度**：音色训练可能需要后端支持

### 9.2 解决方案

- 使用模型压缩技术
- 提供降级方案
- 允许用户调整参数优化音质
- 考虑提供云端训练服务作为选项

## 10. 后续扩展

- **情感朗读**：根据文本情感调整语调
- **多语言支持**：支持更多语言的音色
- **音色市场**：用户分享和下载音色
- **实时变声**：实时调整音色参数
- **AI 增强**：使用 LLM 优化朗读效果
