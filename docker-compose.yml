# Reader 在线阅读 - Docker Compose
# =================================
# Rust 引擎 (reader-rs) + Vue3 前端 (web-v3) + Flaresolverr (CF绕过)
#
# 使用方法:
#   docker compose up -d
#
# 更新方式:
#   docker compose pull && docker compose up -d

services:
  # Reader-RS: Rust 后端 + Vue3 前端
  reader:
    build:
      context: .
      dockerfile: reader-rs/Dockerfile.full
    container_name: reader
    restart: unless-stopped
    ports:
      - "4396:8080" # 访问端口（可自定义）
    volumes:
      - ./data/storage:/app/storage # 数据持久化
      - ./data/logs:/app/logs # 日志
    environment:
      - TZ=Asia/Shanghai
      # Flaresolverr 自动绕过 Cloudflare
      - FLARESOLVERR_URL=http://flaresolverr:8191/v1
      # 日志级别
      - RUST_LOG=info,reader_rs=info
    depends_on:
      - flaresolverr
    networks:
      - reader-network

  # Flaresolverr: 自动绕过 Cloudflare 保护
  # 当访问 69shuba 等受保护网站时自动调用
  flaresolverr:
    image: ghcr.io/flaresolverr/flaresolverr:latest
    container_name: flaresolverr
    restart: unless-stopped
    environment:
      - TZ=Asia/Shanghai
      - LOG_LEVEL=info
      - LOG_HTML=false
      - CAPTCHA_SOLVER=none
      - HEADLESS=true
    networks:
      - reader-network
    # 调试时取消注释以暴露端口
    # ports:
    #   - "8191:8191"

    # 自动更新 (可选)
  watchtower:
    image: containrrr/watchtower
    container_name: reader-watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - TZ=Asia/Shanghai
    command: reader flaresolverr reader-watchtower --cleanup --schedule "0 0 4 * * *"
    networks:
      - reader-network

networks:
  reader-network:
    driver: bridge

volumes:
  reader-data:
